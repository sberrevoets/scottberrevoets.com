<!DOCTYPE html>
<html lang="en">
<head>
          <title>Re-binding self: the debugger's break(ing) point - Scott Berrevoets</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/png" href="https://scottberrevoets.com/theme/images/favicon.png">
        <link rel="apple-touch-icon" type="image/png" sizes="any" href="https://scottberrevoets.com/theme/images/favicon.png">
        <link href="https://scottberrevoets.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Scott Berrevoets Full Atom Feed" />
        <link href="https://scottberrevoets.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Scott Berrevoets Full RSS Feed" />
        <link href="https://scottberrevoets.com/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Scott Berrevoets Atom Feed" />
        <link href="https://scottberrevoets.com/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Scott Berrevoets RSS Feed" />



        <link rel="stylesheet" type="text/css" href="https://scottberrevoets.com/theme/css/style.css" />
</head>

<body id="index" class="home">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="github" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="mastodon" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M18.648 15.254c-1.816 1.763 -6.648 1.626 -6.648 1.626a18.262 18.262 0 0 1 -3.288 -.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013 -13.598 5.257 -13.668 -7.636l-.026 -1.154c0 -3.036 .023 -4.115 1.352 -5.633c1.671 -1.91 6.648 -1.666 6.648 -1.666s4.977 -.243 6.648 1.667c1.329 1.518 1.352 2.597 1.352 5.633s-.456 4.074 -1.352 4.944z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M12 11.204v-2.926c0 -1.258 -.895 -2.278 -2 -2.278s-2 1.02 -2 2.278v4.722m4 -4.722c0 -1.258 .895 -2.278 2 -2.278s2 1.02 2 2.278v4.722" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="mail" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M3 7l9 6l9 -6" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="rss" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 4a16 16 0 0 1 16 16" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 11a9 9 0 0 1 9 9" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="linkedin" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M8 11l0 5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M8 8l0 .01" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M12 16l0 -5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M16 16v-3a2 2 0 0 0 -4 0" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
</svg>        <header id="banner" class="body">
            <div class="header-top">
                <h1><a href="https://scottberrevoets.com/">Scott Berrevoets</a></h1>

                <ul id="social">
                    <li><a href="https://github.com/sberrevoets">
                        <svg class="icon"><use href="#github" /></svg>
                    </a></li>
                    <li><a href="https://linkedin.com/in/sberrevoets">
                        <svg class="icon"><use href="#linkedin" /></svg>
                    </a></li>
                    <li><a href="https://hachyderm.io/@ScottBerrevoets">
                        <svg class="icon"><use href="#mastodon" /></svg>
                    </a></li>
                    <li><a href="mailto:hi@scottberrevoets.com">
                        <svg class="icon"><use href="#mail" /></svg>
                    </a></li>
                    <li><a href="/feeds/all.atom.xml">
                        <svg class="icon"><use href="#rss" /></svg>
                    </a></li>
                </ul>
            </div>

            <nav id="menu"><ul>
                <li><a href="https://scottberrevoets.com/">About</a></li>
                <li><a href="https://scottberrevoets.com/blog.html">Blog</a></li>
            </ul></nav><!-- /#menu -->
        </header><!-- /#banner -->
<section id="content" class="body">
  <header>
      <h2 class="article-title">Re-binding self: the debugger's break(ing) point</h2>
 
    <time class="published subheader" datetime="2018-08-08T00:00:00-07:00">
      August 08, 2018
    </time>
        <span class="subheader">&bullet; 4 min read</span>
  </header>
  <div class="article-content">
    <p><strong>Update 07-29-2019: The bug described below is fixed in Xcode 11 so this blog
post has become irrelevant. I'm leaving it up for historical purposes.</strong></p>
<p>For the Objective-C veterans in the audience, the strong-self-weak-self dance is
a practice mastered early on and one that is used very frequently. There are a
lot of different incantations, but the most basic one goes something like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">__weak</span><span class="w"> </span><span class="nf">typeof</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="w"> </span><span class="n">weakSelf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">self</span><span class="p">;</span>
<span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span><span class="w"> </span><span class="o">^</span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="n">weakSelf</span><span class="w"> </span><span class="n">doSomething</span><span class="p">];</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>

<p>Then, if you needed a strong reference to <code>self</code> again inside the block, you'd
change it to this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">__weak</span><span class="w"> </span><span class="nf">typeof</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span><span class="w"> </span><span class="n">weakSelf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">self</span><span class="p">;</span>
<span class="n">dispatch_group_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">(),</span><span class="w"> </span><span class="o">^</span><span class="p">{</span>
<span class="w">    </span><span class="k">typeof</span><span class="p">(</span><span class="n">weakSelf</span><span class="p">)</span><span class="w"> </span><span class="n">strongSelf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weakSelf</span><span class="p">;</span>
<span class="w">    </span><span class="p">[</span><span class="n">strongSelf</span><span class="p">.</span><span class="n">someOtherObject</span><span class="w"> </span><span class="n">doSomethingWith</span><span class="o">:</span><span class="n">strongSelf</span><span class="p">];</span>
<span class="p">});</span>
</code></pre></div></td></tr></table></div>

<p>Fortunately, this was much easier on day 1 of Swift when using the <code>[weak self]</code>
directive:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">strongSelf</span> <span class="p">=</span> <span class="kc">self</span> <span class="p">{</span>
        <span class="n">strongSelf</span><span class="p">.</span><span class="n">someOtherObject</span><span class="p">.</span><span class="n">doSomething</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">strongSelf</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p><code>self</code> is now <code>weak</code> inside the closure, making it an optional. Unwrapping it
into <code>strongSelf</code> makes it a non-optional while still avoiding a retain cycle.
It doesn't feel very Swifty, but it's not terrible.</p>
<p>More recently, it's become known that Swift supports re-binding <code>self</code> if you
wrap it in backticks. That makes for an arguably much nicer syntax:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="p">`</span><span class="kc">self</span><span class="p">`</span> <span class="p">=</span> <span class="kc">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="kc">self</span><span class="p">.</span><span class="n">someOtherObject</span><span class="p">.</span><span class="n">doSomething</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="kc">self</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>This was long considered, and <a href="https://lists.swift.org/pipermail/swift-evolution/Week-of-Mon-20160118/007425.html">confirmed</a> to be, a hack that worked due to a bug in the compiler, but
since it worked and there weren't plans to remove it, people (including us at
Lyft) started treating it as a feature.</p>
<p><strong>However, there is one big caveat</strong>: the debugger is entirely hosed for
anything you do in that closure. Ever seen an error like this in your Xcode
console?</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">error</span><span class="o">:</span><span class="w"> </span><span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">EXPR</span><span class="o">&gt;:</span><span class="mi">12</span><span class="o">:</span><span class="mi">9</span><span class="o">:</span><span class="w"> </span><span class="n">warning</span><span class="o">:</span><span class="w"> </span><span class="n">initialization</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="s1">&#39;$__lldb_error_result&#39;</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">used</span><span class="o">;</span><span class="w"> </span><span class="n">consider</span><span class="w"> </span><span class="n">replacing</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">assignment</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">removing</span><span class="w"> </span><span class="n">it</span>
<span class="w">    </span><span class="n">var</span><span class="w"> </span><span class="n">$__lldb_error_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__lldb_tmp_error</span>
<span class="w">        </span><span class="o">~~~~^~~~~~~~~~~~~~~~~~~~</span>
</code></pre></div></td></tr></table></div>

<p>That's because <code>self</code> was re-bound. This is easy to reproduce: create a new
Xcode project and add the following snippet to <code>viewDidLoad()</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="k">async</span> <span class="p">{</span> <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="kd">let</span> <span class="p">`</span><span class="kc">self</span><span class="p">`</span> <span class="p">=</span> <span class="kc">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>

    <span class="kd">let</span> <span class="nv">description</span> <span class="p">=</span> <span class="kc">self</span><span class="p">.</span><span class="n">description</span>
    <span class="bp">print</span><span class="p">(</span><span class="n">description</span><span class="p">)</span> <span class="c1">// set a breakpoint here</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>

<p>When the breakpoint hits, execute <code>(lldb) po description</code> and you'll see the
error from above. Note that you're not even <em>using</em> <code>self</code> - merely re-binding
it makes the debugger entirely useless inside that scope.</p>
<p>People with way more knowledge of LLDB than I do can explain this in more detail
(and <a href="https://bugs.swift.org/browse/SR-6156">have</a>), but the gist is that the
debugger doesn't like <code>self</code>'s type changing. At the beginning of the closure
scope, the debugging context assumes that <code>self</code>'s type is <code>Optional</code>, but it is
then re-bound to a non-optional, which the debugger doesn't know how to handle.
It's actually pretty surprising the compiler supports changing a variable's type
at all.</p>
<p>Because of this problem, at Lyft we have decided to eliminate this pattern
entirely in our codebases, and instead re-bind <code>self</code> to a variable named
<code>this</code>.</p>
<p>If you do continue to use this pattern, note that in a
<a href="https://forums.swift.org/t/the-future-of-weak-self-rebinding/10846">discussion</a>
on the Swift forums many people agreed that re-binding <code>self</code> should be
supported by the language without the need for backticks. The <a href="https://github.com/apple/swift/pull/15306">pull
request</a> was merged shortly after and
with the release of Swift 4.2 in the fall, you'll be able to use <code>guard let self
= self else { return }</code> (at the cost of losing debugging capabilities!)</p>
  </div><!-- /.entry-content -->
</section>

  <script data-goatcounter="https://sberrevoets.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>