<!DOCTYPE html>
<html lang="en">
<head>
          <title>Localization troubles with Swift PM - Scott Berrevoets</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/png" href="https://scottberrevoets.com/theme/images/favicon.png">
        <link rel="apple-touch-icon" type="image/png" sizes="any" href="https://scottberrevoets.com/theme/images/favicon.png">
        <link href="https://scottberrevoets.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Scott Berrevoets Full Atom Feed" />
        <link href="https://scottberrevoets.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Scott Berrevoets Full RSS Feed" />
        <link href="https://scottberrevoets.com/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Scott Berrevoets Atom Feed" />
        <link href="https://scottberrevoets.com/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Scott Berrevoets RSS Feed" />

    <meta name="description" content="An overview of how localizing works when an app is modularized with Swift PM" />


        <link rel="stylesheet" type="text/css" href="https://scottberrevoets.com/theme/css/style.css" />
</head>

<body id="index" class="home">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="github" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="mastodon" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M18.648 15.254c-1.816 1.763 -6.648 1.626 -6.648 1.626a18.262 18.262 0 0 1 -3.288 -.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013 -13.598 5.257 -13.668 -7.636l-.026 -1.154c0 -3.036 .023 -4.115 1.352 -5.633c1.671 -1.91 6.648 -1.666 6.648 -1.666s4.977 -.243 6.648 1.667c1.329 1.518 1.352 2.597 1.352 5.633s-.456 4.074 -1.352 4.944z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M12 11.204v-2.926c0 -1.258 -.895 -2.278 -2 -2.278s-2 1.02 -2 2.278v4.722m4 -4.722c0 -1.258 .895 -2.278 2 -2.278s2 1.02 2 2.278v4.722" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="mail" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M3 7l9 6l9 -6" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="rss" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 4a16 16 0 0 1 16 16" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 11a9 9 0 0 1 9 9" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="linkedin" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M8 11l0 5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M8 8l0 .01" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M12 16l0 -5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M16 16v-3a2 2 0 0 0 -4 0" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
</svg>        <header id="banner" class="body">
            <div class="header-top">
                <h1><a href="https://scottberrevoets.com/">Scott Berrevoets</a></h1>

                <ul id="social">
                    <li><a href="https://github.com/sberrevoets">
                        <svg class="icon"><use href="#github" /></svg>
                    </a></li>
                    <li><a href="https://linkedin.com/in/sberrevoets">
                        <svg class="icon"><use href="#linkedin" /></svg>
                    </a></li>
                    <li><a href="https://hachyderm.io/@ScottBerrevoets">
                        <svg class="icon"><use href="#mastodon" /></svg>
                    </a></li>
                    <li><a href="mailto:hi@scottberrevoets.com">
                        <svg class="icon"><use href="#mail" /></svg>
                    </a></li>
                    <li><a href="/feeds/all.atom.xml">
                        <svg class="icon"><use href="#rss" /></svg>
                    </a></li>
                </ul>
            </div>

            <nav id="menu"><ul>
                <li><a href="https://scottberrevoets.com/">About</a></li>
                <li><a href="https://scottberrevoets.com/blog.html">Blog</a></li>
            </ul></nav><!-- /#menu -->
        </header><!-- /#banner -->
<section id="content" class="body">
  <header>
      <h2 class="article-title">Localization troubles with Swift PM</h2>
 
    <time class="published subheader" datetime="2025-09-19T00:00:00-07:00">
      September 19, 2025
    </time>
        <span class="subheader">&bullet; 5 min read</span>
  </header>
  <div class="article-content">
    <p>A few weeks ago we got bit by a piece of Apple magic in its localization
workflow when combined with Swift PM. The problem we ran into was that as soon
as we moved all our <code>Localizable.strings</code> files to an SPM package, none of the
localizations would be picked up anymore and the app would display in
English&mdash;but <strong>only for first-time installations</strong>. We followed the
documentation guidelines for how to localize an app in an Swift PM environment
and have no custom tooling in place, so it was a bit of a headscratcher.</p>
<p>The modern way of adding support for another language/region in Xcode is through
the project's <em>Info</em> tab. Simply click the + and add a language and the app now
supports localizing in that language.</p>
<p>Adding localizations for any resource is done by clicking the <em>Localize...</em>
button in the Attributes inspector. After confirming the language, Xcode creates
a new <code>.lproj</code> folder for the selected language and moves the resource into that
folder. The end result is the project will have a <code>.lproj</code> folder for each
localization as well as the <code>Base.lproj</code>.</p>
<p>This <em>just works</em>. The <code>.lproj</code> folders get copied over to the <code>.app</code> and at
runtime the SDK knows how to read and use these folders. Xcode also gives visual
confirmation in the <em>Info</em> tab by indicating for how many files it has picked up
a localized version per language/region.</p>
<p><img alt="Xcode sees three localized files" src="/images/xcode-localizations-3.png"></p>
<p>Getting started with adding some SPM packages in our app, we moved the <code>.lproj</code>
folders into our <code>Localization</code> package at
<code>Localization/Sources/Localization/Resources/</code>, which follows the process
outlined in the <a href="https://developer.apple.com/documentation/xcode/localizing-package-resources">documentation</a>. Locally this seemed to work and we shipped the
change, only for QA to report localizations were broken throughout the app.</p>
<p>As it turns out, any <code>.lproj</code> folders in <strong>SPM packages</strong> aren't considered when
determining what localizations are available. At first this was a bit confusing,
but it makes sense for two reasons:</p>
<ol>
<li>Through various layers of abstraction, the system looks up the available
   localizations using methods on <code>Bundle</code>. <code>Bundle.localizations</code> simply finds
   all <code>.lproj</code> folders in that bundle. SPM package bundles aren't included in
   <code>Bundle.main</code>, which is the bundle that's used to determine app-wide
   localizations.</li>
<li>An SPM package can be localized in different languages than the app that
   integrates the package, especially if the package is from an external vendor.
   It could be weird behavior to have the app's selected localization be
   determined by some SPM package.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is an Info.plist key that would allow SPM packages to use a different
localization than the main app: <code>CFBundleAllowMixedLocalizations</code>.
I haven't tried for myself, but setting this to <code>YES</code> allows different
localizations for the app and for every package.</p>
</div>
<p>When moving all <code>.lproj</code> folders into the SPM package, the app didn't have any
localized files left and Xcode indicated as much. </p>
<p><img alt="Xcode sees no localized files" src="/images/xcode-localizations-0.png"></p>
<p>As a result, the app would always default to English. This explained why things
were broken but there were still a few questions left.</p>
<p><strong>How come the correct localization was used for returning users?</strong></p>
<p>This issue only happened to users that freshly installed the app. Upon first
launch, we store the user's locale in <code>UserDefaults</code> (later giving users the
ability to override this manually). Instead of reading strings from
<code>Bundle.main</code> we read them from a new <code>Bundle</code> instance specifically scoped to
that locale:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">let</span> <span class="nv">defaultLocale</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">preferredLocalizations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="kd">let</span> <span class="nv">userLanguage</span> <span class="p">=</span> <span class="n">UserDefaults</span><span class="p">.</span><span class="n">shared</span><span class="p">.</span><span class="n">language</span> <span class="c1">// e.g. &quot;nl&quot; for Dutch</span>
<span class="kd">let</span> <span class="nv">path</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">.</span><span class="n">main</span><span class="p">.</span><span class="n">pathForResource</span><span class="p">(</span><span class="n">language</span> <span class="p">??</span> <span class="n">defaultLocale</span> <span class="p">,</span> <span class="n">ofType</span><span class="p">:</span> <span class="s">&quot;lproj&quot;</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">customBundle</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">path</span><span class="p">)</span>

<span class="kd">let</span> <span class="nv">localized</span> <span class="p">=</span> <span class="n">customBundle</span><span class="p">.</span><span class="n">localizedString</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>This setup has some interesting results:</p>
<ul>
<li>❌ <code>Bundle.main.preferredLocalizations</code> only contains the development default
  locale <code>en</code> as the main bundle doesn't have any localizations</li>
<li>❌ <code>customBundle.preferredLocalizations</code> only contains the localization it was
  scoped to</li>
<li>✅ <code>customBundle.localizedString(forKey:value:table:)</code> works as the SPM
  package's resources still get copied into the main app as a separate bundle</li>
<li>✅ <code>Bundle.module.preferredLocalizations</code> correctly returns all the supported
  localizations since they're defined in the SPM package</li>
<li>✅ <code>Bundle.module.localizedString(forKey:value:table:)</code> works for the same
  reason</li>
<li>❌ <code>Bundle.main.localizedString(forKey:value:table:)</code> does not work as the
  main bundle doesn't have any localizations</li>
</ul>
<p>For first-time users we would read <code>en</code> as their preferred language through
<code>Bundle.main.preferredLocalizations</code>, but for returning users we'd read what
language they were using before from <code>UserDefaults</code>.</p>
<p>Conclusion: we should be using <code>Bundle.module.preferredLocalizations</code> instead.</p>
<p><strong>Why was it so difficult to figure this out?</strong></p>
<p>The build cache in Xcode messed with our ability to reproduce the issue. In
understanding what commit introduced the problem, we would often switch branches
but that didn't invalidate the build cache.</p>
<p>So building any commit before the offending change would copy the <code>.lproj</code>
folders into the main app's build cache, and those folders would stay there
after checking out and building the offending commit.</p>
<p>At first we thought the issue was only intermittently reproducible, but once we
realized the build cache was "polluted" we started to clean it every time. This
made it much easier to reproduce but much slower to test due to constantly doing
full builds.</p>
<p><strong>What am I supposed to do in a fully modularized app where there are no files
to localize in the main app?</strong></p>
<p>In theory, using <code>Bundle.module</code> everywhere would work as highlighted above.
However, that's pretty cumbersome and there's a nicer way:
<code>CFBundleLocalizations</code>. This is another <a href="https://developer.apple.com/documentation/bundleresources/information-property-list/cfbundlelocalizations">Info.plist key</a> that lets you
<em>explicitly</em> define what localizations the app handles, instead of looking for
<code>.lproj</code> folders and implicitly supporting the localizations for the folders
Xcode finds. With that key set, Xcode still does look for these folders but now
it also considers SPM bundles, fixing the issue.</p>
<p>Finally, there's another way to be explicit about the localizations a project
supports: by adding a localization through Xcode's <em>Info</em> tab. This sets the
<code>knownRegions</code> value in the Xcode project file, which is not only considered for
determining what localizations to consider at build time, but is also used to
export and import <code>xliff</code> files.</p>
<p>That would have fixed our issue as well, but I personally prefer to not touch
the project file as much as possible and be explicit about what localizations
are supported through <code>CFBundleLocalizations</code>.</p>
  </div><!-- /.entry-content -->
</section>

  <script data-goatcounter="https://sberrevoets.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>