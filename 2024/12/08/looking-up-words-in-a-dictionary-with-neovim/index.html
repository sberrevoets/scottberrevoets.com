<!DOCTYPE html>
<html lang="en">
<head>
          <title>Looking up words in a dictionary with Neovim - Scott Berrevoets</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/png" href="https://scottberrevoets.com/theme/images/favicon.png">
        <link rel="apple-touch-icon" type="image/png" sizes="any" href="https://scottberrevoets.com/theme/images/favicon.png">
        <link href="https://scottberrevoets.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Scott Berrevoets Full Atom Feed" />
        <link href="https://scottberrevoets.com/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Scott Berrevoets Full RSS Feed" />
        <link href="https://scottberrevoets.com/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="Scott Berrevoets Atom Feed" />
        <link href="https://scottberrevoets.com/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="Scott Berrevoets RSS Feed" />



        <link rel="stylesheet" type="text/css" href="https://scottberrevoets.com/theme/css/style.css" />
</head>

<body id="index" class="home">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="github" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="mastodon" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M18.648 15.254c-1.816 1.763 -6.648 1.626 -6.648 1.626a18.262 18.262 0 0 1 -3.288 -.256c1.127 1.985 4.12 2.81 8.982 2.475c-1.945 2.013 -13.598 5.257 -13.668 -7.636l-.026 -1.154c0 -3.036 .023 -4.115 1.352 -5.633c1.671 -1.91 6.648 -1.666 6.648 -1.666s4.977 -.243 6.648 1.667c1.329 1.518 1.352 2.597 1.352 5.633s-.456 4.074 -1.352 4.944z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M12 11.204v-2.926c0 -1.258 -.895 -2.278 -2 -2.278s-2 1.02 -2 2.278v4.722m4 -4.722c0 -1.258 .895 -2.278 2 -2.278s2 1.02 2 2.278v4.722" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="mail" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M3 7l9 6l9 -6" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="rss" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 4a16 16 0 0 1 16 16" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 11a9 9 0 0 1 9 9" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
  <symbol id="linkedin" viewBox="0 0 24 24">
    <path stroke="none" d="M0 0h24v24H0z" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M8 11l0 5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M8 8l0 .01" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M12 16l0 -5" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M16 16v-3a2 2 0 0 0 -4 0" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
  </symbol>
</svg>        <header id="banner" class="body">
            <div class="header-top">
                <h1><a href="https://scottberrevoets.com/">Scott Berrevoets</a></h1>

                <ul id="social">
                    <li><a href="https://github.com/sberrevoets">
                        <svg class="icon"><use href="#github" /></svg>
                    </a></li>
                    <li><a href="https://linkedin.com/in/sberrevoets">
                        <svg class="icon"><use href="#linkedin" /></svg>
                    </a></li>
                    <li><a href="https://hachyderm.io/@ScottBerrevoets">
                        <svg class="icon"><use href="#mastodon" /></svg>
                    </a></li>
                    <li><a href="mailto:hi@scottberrevoets.com">
                        <svg class="icon"><use href="#mail" /></svg>
                    </a></li>
                    <li><a href="/feeds/all.atom.xml">
                        <svg class="icon"><use href="#rss" /></svg>
                    </a></li>
                </ul>
            </div>

            <nav id="menu"><ul>
                <li><a href="https://scottberrevoets.com/">About</a></li>
                <li><a href="https://scottberrevoets.com/blog.html">Blog</a></li>
            </ul></nav><!-- /#menu -->
        </header><!-- /#banner -->
<section id="content" class="body">
  <header>
      <h2 class="article-title">Looking up words in a dictionary with Neovim</h2>
 
    <time class="published subheader" datetime="2024-12-08T00:00:00-08:00">
      December 08, 2024
    </time>
        <span class="subheader">&bullet; 12 min read</span>
  </header>
  <div class="article-content">
    <p>When writing code in neovim, I frequently use <code>K</code> to look up documentation,
function signatures, variable definitions, etc. In markdown files that doesn't
make too much sense, but I wanted to use it to look up words in the dictionary
instead. This didn't appear to be possible out of the box but the power of
(neo)vim is its extensibility so I decided to build it myself.</p>
<p>The steps to build this roughly were:</p>
<ol>
<li>Write a dictionary lookup tool</li>
<li>Parse this tool's output and show it in neovim</li>
<li>Configure neovim's <code>K</code> functionality</li>
</ol>
<h2 id="dict"><code>dict</code></h2>
<p><code>dict</code> seemed like an appropriate, easy name to look up a word in the
dictionary. As I'm a macOS user I first wanted to use the built-in dictionary
through
<a href="https://gist.github.com/lambdamusic/bdd56b25a5f547599f7f"><code>pyobjc-framework-CoreServices</code></a>
but <code>DCSCopyTextDefinition</code> doesn't return dictionary entries in a
well-structured or consistent way, so I ultimately decided to write a quick
lookup using <a href="https://dictionaryapi.dev">dictionaryapi.dev</a>. I also added some
other formatting and ANSI coloring to improve the CLI output:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="n">_TERMINAL_RESET</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
<span class="n">_TERMINAL_BOLD</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m&quot;</span>
<span class="n">_TERMINAL_DIM</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[2m&quot;</span>
<span class="n">_TERMINAL_RED</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[91m&quot;</span>
<span class="n">_TERMINAL_GREEN</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[92m&quot;</span>
<span class="n">_TERMINAL_BLUE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[94m&quot;</span>


<span class="k">def</span> <span class="nf">_fetch_word_definition</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://api.dictionaryapi.dev/api/v2/entries/en/</span><span class="si">{</span><span class="n">word</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="c1"># Handle API errors</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_format_definition_output</span><span class="p">(</span><span class="n">word_data</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">word_data</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_TERMINAL_RED</span><span class="si">}</span><span class="s2">error: word not found</span><span class="si">{</span><span class="n">_TERMINAL_RESET</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">word</span> <span class="o">=</span> <span class="n">word_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;word&quot;</span><span class="p">]</span>
    <span class="n">meanings</span> <span class="o">=</span> <span class="n">word_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meanings&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_TERMINAL_GREEN</span><span class="si">}{</span><span class="n">_TERMINAL_BOLD</span><span class="si">}{</span><span class="n">word</span><span class="si">}{</span><span class="n">_TERMINAL_RESET</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">for</span> <span class="n">part_of_speech</span> <span class="ow">in</span> <span class="n">meanings</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">part_of_speech</span><span class="p">[</span><span class="s2">&quot;partOfSpeech&quot;</span><span class="p">]</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">_TERMINAL_BLUE</span><span class="si">}{</span><span class="n">pos</span><span class="si">}{</span><span class="n">_TERMINAL_RESET</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">synonyms</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">part_of_speech</span><span class="p">[</span><span class="s2">&quot;synonyms&quot;</span><span class="p">])</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">_TERMINAL_DIM</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">synonyms</span><span class="si">}</span><span class="s2">)</span><span class="si">{</span><span class="n">_TERMINAL_RESET</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">synonyms</span>
            <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">definition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">part_of_speech</span><span class="p">[</span><span class="s2">&quot;definitions&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">definition_text</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;definition&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">example</span> <span class="o">=</span> <span class="n">definition</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;example&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">definition_text</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">example</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (e.g., </span><span class="si">{</span><span class="n">example</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="n">output</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">output</span>


<span class="k">def</span> <span class="nf">_get_word_definition</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="n">word_data</span> <span class="o">=</span> <span class="n">_fetch_word_definition</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_format_definition_output</span><span class="p">(</span><span class="n">word_data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Fetch word definitions from API dictionary.dev.&quot;</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;word&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Word to look up&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">word</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">word</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">_get_word_definition</span><span class="p">(</span><span class="n">word</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

<p>This file needs to be in the <code>PATH</code> which I did by putting it in
<code>~/.bin/dict.py</code> and setting <code>export PATH="$HOME/.bin:$PATH"</code>.</p>
<p><code>dict ambiguous</code> now gives a nicely formatted definition:</p>
<p><img alt="Dictionary lookup of the word ambiguous in the
terminal" src="/images/dictionary-lookup-cli.png"></p>
<h2 id="neovim-integration">Neovim integration</h2>
<p>I wanted to invoke <code>dict</code> using <code>K</code> passing in the word under the cursor as the
trigger and showing the output in a popup window. Other than the plain vim
configuration this required some text manipulation so I put all that in
<code>~/.vim/plugin/dictionary.lua</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1">-- Create a new buffer with the given message and apply ANSI highlighting</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">create_buf</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_create_buf</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>

  <span class="kd">local</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">plain</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
  <span class="kr">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="kr">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="kr">do</span>
    <span class="kd">local</span> <span class="n">stripped</span> <span class="o">=</span> <span class="n">line</span><span class="p">:</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[[0-9;]+m&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_buf_set_lines</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="n">stripped</span> <span class="p">})</span>
    <span class="n">apply_ansi_highlighting</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
  <span class="kr">end</span>

  <span class="kr">return</span> <span class="n">buf</span>
<span class="kr">end</span>

<span class="c1">-- Show a popup window with the given buffer</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">show_popup</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
  <span class="n">vim</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">popup_window</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_open_win</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span>
    <span class="n">relative</span> <span class="o">=</span> <span class="s2">&quot;cursor&quot;</span><span class="p">,</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">anchor</span> <span class="o">=</span> <span class="s2">&quot;NW&quot;</span><span class="p">,</span>
    <span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;minimal&quot;</span><span class="p">,</span>
    <span class="n">border</span> <span class="o">=</span> <span class="s2">&quot;single&quot;</span><span class="p">,</span>
  <span class="p">})</span>
<span class="kr">end</span>

<span class="c1">-- Close the popup window</span>
<span class="kr">function</span> <span class="nf">ClosePopup</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">window</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">popup_window</span>
  <span class="kr">if</span> <span class="n">vim</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">popup_window</span> <span class="ow">and</span> <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_win_is_valid</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_win_close</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="n">vim</span><span class="p">.</span><span class="n">g</span><span class="p">.</span><span class="n">popup_window</span> <span class="o">=</span> <span class="kc">nil</span>
  <span class="kr">end</span>
<span class="kr">end</span>

<span class="c1">-- Look up the definition of the word under the cursor</span>
<span class="kr">function</span> <span class="nf">DictionaryLookup</span><span class="p">()</span>
  <span class="kd">local</span> <span class="n">word</span> <span class="o">=</span> <span class="n">vim</span><span class="p">.</span><span class="n">fn</span><span class="p">.</span><span class="n">expand</span><span class="p">(</span><span class="s2">&quot;&lt;cword&gt;&quot;</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">file</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="nb">io.popen</span><span class="p">(</span><span class="s2">&quot;dict &quot;</span> <span class="o">..</span> <span class="n">word</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span>
  <span class="kd">local</span> <span class="n">definition</span> <span class="o">=</span> <span class="nb">assert</span><span class="p">(</span><span class="n">file</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;*a&quot;</span><span class="p">))</span>
  <span class="n">file</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
  <span class="n">show_popup</span><span class="p">(</span><span class="n">create_buf</span><span class="p">(</span><span class="n">definition</span><span class="p">))</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<p>This creates 2 functions, <code>DictionaryLookup()</code> and <code>ClosePopup()</code> that show and
dismiss the popup, stripping the ANSI codes from the output as they were
rendered raw in the popup.</p>
<p>However, note the call to <code>apply_ansi_highlighting</code> (line 9),
which replaces the ANSI codes with neovim specific highlight groups. This turned
out to be quite involved but I wanted the formatted output and used this as an
opportunity to learn lua a bit more. </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_set_hl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">fg</span> <span class="o">=</span> <span class="s2">&quot;fg&quot;</span><span class="p">,</span> <span class="n">bold</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">underline</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">italic</span> <span class="o">=</span> <span class="kc">false</span> <span class="p">})</span>
<span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_set_hl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Bold&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">bold</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span> <span class="n">underline</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
<span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_set_hl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Dim&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">fg</span> <span class="o">=</span> <span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">italic</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">})</span>
<span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_set_hl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Red&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">fg</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span> <span class="p">})</span>
<span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_set_hl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Green&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">fg</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span> <span class="p">})</span>
<span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_set_hl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Blue&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="n">fg</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span> <span class="p">})</span>

<span class="kd">local</span> <span class="n">ansi_patterns</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[0m&quot;</span><span class="p">,</span> <span class="n">highlight</span> <span class="o">=</span> <span class="s2">&quot;Normal&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[1m&quot;</span><span class="p">,</span> <span class="n">highlight</span> <span class="o">=</span> <span class="s2">&quot;Bold&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[2m&quot;</span><span class="p">,</span> <span class="n">highlight</span> <span class="o">=</span> <span class="s2">&quot;Dim&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[91m&quot;</span><span class="p">,</span> <span class="n">highlight</span> <span class="o">=</span> <span class="s2">&quot;Red&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[92m&quot;</span><span class="p">,</span> <span class="n">highlight</span> <span class="o">=</span> <span class="s2">&quot;Green&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[94m&quot;</span><span class="p">,</span> <span class="n">highlight</span> <span class="o">=</span> <span class="s2">&quot;Blue&quot;</span> <span class="p">},</span>
<span class="p">}</span>

<span class="c1">-- Find the highlight group for a given ANSI escape code</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">find_ansi_pattern</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
  <span class="kr">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entry</span> <span class="kr">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">ansi_patterns</span><span class="p">)</span> <span class="kr">do</span>
    <span class="kr">if</span> <span class="n">text</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">pattern</span><span class="p">)</span> <span class="kr">then</span>
      <span class="kr">return</span> <span class="n">entry</span><span class="p">.</span><span class="n">highlight</span>
    <span class="kr">end</span>
  <span class="kr">end</span>
  <span class="kr">return</span> <span class="kc">nil</span>
<span class="kr">end</span>

<span class="c1">-- Apply ANSI highlighting to a line of text in the given buffer</span>
<span class="kd">local</span> <span class="kr">function</span> <span class="nf">apply_ansi_highlighting</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">line_num</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
  <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">:</span><span class="n">gsub</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[0m$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\27</span><span class="s2">%[[0-9]+m&quot;</span>

  <span class="kd">local</span> <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="n">text</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">..</span> <span class="n">pattern</span> <span class="o">..</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
  <span class="kd">local</span> <span class="n">cursor</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="kd">local</span> <span class="n">pos_in_stripped</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="kd">local</span> <span class="nb">next</span> <span class="o">=</span> <span class="n">text</span>
  <span class="kr">while</span> <span class="n">start_pos</span> <span class="kr">do</span>
    <span class="kr">if</span> <span class="nb">next</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;^&quot;</span> <span class="o">..</span> <span class="n">pattern</span><span class="p">)</span> <span class="kr">then</span>
      <span class="n">start_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">match</span> <span class="o">=</span> <span class="nb">next</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;(&quot;</span> <span class="o">..</span> <span class="n">pattern</span> <span class="o">..</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
      <span class="n">cursor</span> <span class="o">=</span> <span class="n">end_pos</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_buf_add_highlight</span><span class="p">(</span>
        <span class="n">buf</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">find_ansi_pattern</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;Normal&quot;</span><span class="p">,</span>
        <span class="n">line_num</span><span class="p">,</span>
        <span class="n">pos_in_stripped</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span>
      <span class="p">)</span>
    <span class="kr">else</span>
      <span class="n">start_pos</span> <span class="o">=</span> <span class="nb">next</span><span class="p">:</span><span class="n">find</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
      <span class="kr">if</span> <span class="n">start_pos</span> <span class="kr">then</span>
        <span class="n">pos_in_stripped</span> <span class="o">=</span> <span class="n">pos_in_stripped</span> <span class="o">+</span> <span class="n">start_pos</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">start_pos</span>
      <span class="kr">end</span>
    <span class="kr">end</span>

    <span class="nb">next</span> <span class="o">=</span> <span class="nb">next</span><span class="p">:</span><span class="n">sub</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="kr">end</span>
<span class="kr">end</span>
</code></pre></div></td></tr></table></div>

<h2 id="configuring-k">Configuring <code>K</code></h2>
<p>Opening any file and calling <code>:lua DictionaryLookup()</code> already works (and <code>:lua
ClosePopup()</code> to dismiss it) but that's a lot of typing and it better fits <code>K</code>
in markdown files since that's otherwise unused anyway.</p>
<p>I mapped the first to a vim command <code>:Dict</code> and wanted to hide the window with
any cursor movement, similar to how this works for other documentation lookups. 
<code>keywordprg</code> is the command that gets invoked through <code>K</code> (and can also be set
through <code>set keywordprg</code>).</p>
<p>I put this in <code>~/.vim/ftplugin/markdown.lua</code> so that it automatically is applied
to markdown files:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_create_user_command</span><span class="p">(</span><span class="s2">&quot;Dict&quot;</span><span class="p">,</span> <span class="n">DictionaryLookup</span><span class="p">,</span> <span class="p">{</span> <span class="n">nargs</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">})</span>
<span class="n">vim</span><span class="p">.</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;keywordprg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;:Dict&quot;</span>

<span class="n">vim</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">nvim_create_autocmd</span><span class="p">(</span><span class="s2">&quot;CursorMoved&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>
  <span class="n">callback</span> <span class="o">=</span> <span class="n">ClosePopup</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></div></td></tr></table></div>

<p>With the end result being:</p>
<p><img alt="Dictionary lookup of the word ambiguous in
neovim" src="/images/dictionary-lookup-neovim.png"></p>
<p>Dictionary lookup also still works in non-markdown files by directly invoking
<code>:Dict</code>, which is a bit more typing but also much less common. That's all that
was needed, now <code>K</code> performs a dictionary lookup and shows it nicely formatted
in-line and is automatically hidden when needed. This may be nice as a generic
plugin as well so I might do that at some point in the future as well.</p>
  </div><!-- /.entry-content -->
</section>

  <script data-goatcounter="https://sberrevoets.goatcounter.com/count"
          async src="//gc.zgo.at/count.js"></script>
</body>
</html>